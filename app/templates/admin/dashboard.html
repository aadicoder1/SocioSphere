{% extends "base.html" %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-4 text-primary">Admin Dashboard</h2>

  <!-- Stats Chart -->
  <canvas id="statsChart" height="100"></canvas>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  const ctx = document.getElementById('statsChart').getContext('2d');
  const statsChart = new Chart(ctx, {
      type: 'bar',
      data: {
          labels: ['Users', 'NGOs', 'Reports', 'Posts', 'Contributions'],
          datasets: [{
              label: 'Count',
              data: [
                  {{ users.total }},
                  {{ ngos.total }},
                  {{ reports.total }},
                  {{ posts.total }},
                  {{ contributions.total }}
              ],
              backgroundColor: ['#007bff','#28a745','#ffc107','#17a2b8','#dc3545']
          }]
      }
  });
  </script>

  <!-- USERS -->
  <h3 class="mt-5 mb-3">All Users</h3>
  <table class="table table-striped table-hover shadow-sm">
    <thead class="table-dark">
      <tr>
        <th>Username</th>
        <th>Email</th>
        <th>Role</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users.items %}
      <tr>
        <td>{{ user.username }}</td>
        <td>{{ user.email }}</td>
        <td><span class="badge bg-{{ 'success' if user.role == 'admin' else 'secondary' }}">{{ user.role|capitalize }}</span></td>
        <td>
          <a href="{{ url_for('admin.edit_user', user_id=user.id) }}" class="btn btn-sm btn-warning">Edit</a>
          <form method="POST" action="{{ url_for('admin.delete_user', user_id=user.id) }}" style="display:inline;">
            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this user?')">Delete</button>
          </form>
          <form method="POST" action="{{ url_for('admin.promote_user', user_id=user.id) }}" style="display:inline;">
            <button type="submit" class="btn btn-sm btn-primary" {% if user.role == 'admin' %}disabled{% endif %}>Promote</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {# Set variables BEFORE including the partial #}
  {% set pagination = users %}
  {% set param = 'user_page' %}
  {% include 'admin/pagination.html' %}

  <!-- NGOS -->
  <h3 class="mt-5 mb-3">NGO Events</h3>
  <div class="row row-cols-1 row-cols-md-3 g-4">
    {% for event in ngos.items %}
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">{{ event.title }}</h5>
          <p><strong>Date:</strong> {{ event.date.strftime('%b %d, %Y') if event.date else 'N/A' }}</p>
          <p>{{ event.description[:100] }}{% if event.description|length > 100 %}...{% endif %}</p>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% set pagination = ngos %}
  {% set param = 'ngo_page' %}
  {% include 'admin/pagination.html' %}

  <!-- REPORTS -->
  <h3 class="mt-5 mb-3">Issue Reports</h3>
  <ul class="list-group">
    {% for report in reports.items %}
      <li class="list-group-item">{{ report.issue }}</li>
    {% else %}
      <li class="list-group-item text-muted">No issue reports.</li>
    {% endfor %}
  </ul>

  {% set pagination = reports %}
  {% set param = 'report_page' %}
  {% include 'admin/pagination.html' %}

  <!-- POSTS -->
  <h3 class="mt-5 mb-3">Posts</h3>
  <ul class="list-group">
    {% for post in posts.items %}
      <li class="list-group-item">{{ post.content }}</li>
    {% else %}
      <li class="list-group-item text-muted">No posts available.</li>
    {% endfor %}
  </ul>

  {% set pagination = posts %}
  {% set param = 'post_page' %}
  {% include 'admin/pagination.html' %}

  <!-- CONTRIBUTIONS -->
  <h3 class="mt-5 mb-3">Contributions</h3>
  <ul class="list-group">
    {% for contribution in contributions.items %}
      <li class="list-group-item">{{ contribution.amount }}{% if contribution.user %} - {{ contribution.user.username }}{% endif %}</li>
    {% else %}
      <li class="list-group-item text-muted">No contributions found.</li>
    {% endfor %}
  </ul>

  {% set pagination = contributions %}
  {% set param = 'contribution_page' %}
  {% include 'admin/pagination.html' %}
</div>
{% endblock %}
