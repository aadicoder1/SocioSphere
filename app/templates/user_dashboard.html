{% extends "base.html" %}

{% block content %}
<div class="container">

  <!-- Welcome Card -->
  <div class="card p-4 mt-4 shadow-lg">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-info flash-messages">
          {% for message in messages %}
            <p class="mb-0">{{ message }}</p>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <script>
      setTimeout(function () {
        const flashBox = document.querySelector('.flash-messages');
        if (flashBox) {
          flashBox.style.display = 'none';
        }
      }, 3000);
    </script>

    <h2 class="mb-3">Welcome, {{ name }}</h2>
    <p>This is your dashboard to raise complaints and track welfare requests.</p>
    <div>
      <a class="btn btn-outline-primary mt-3" href="{{ url_for('report.my_reports') }}" style="text-decoration: none;width:170px;">
        My Issues
      </a>
      <a class="btn btn-outline-primary mt-3" href="{{ url_for('report.report_issue') }}" style="text-decoration: none;width:170px;">
        Report an Issue
      </a>
    </div>
  </div>

  <!-- Events Carousel -->
  {% if events %}
  <div class="card mt-5 p-3 shadow-lg">
    <h3 class="mb-3">Upcoming Events</h3>
    <div id="eventCarousel" class="carousel slide carousel-fade shadow" data-bs-ride="carousel" style="width: 100%; margin: auto;">
      <div class="carousel-inner">
        {% for event in events %}
        <div class="carousel-item {% if loop.index == 1 %}active{% endif %}">
          <img src="{{ url_for('static', filename='uploads/' ~ event.image_filename) }}" 
               class="d-block w-100 rounded" 
               alt="{{ event.title }}" 
               style="height: 300px; object-fit: cover;">
          <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 p-3 rounded">
            <h5>{{ event.title }}</h5>
            <p>{{ event.date }}</p>
            <a href="{{ url_for('main.event_detail', event_id=event.id) }}" class="btn btn-sm btn-light">View Details</a>
          </div>
        </div>
        {% endfor %}
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#eventCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#eventCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
      </button>
    </div>
  </div>
  {% endif %}

  <!-- Posts Section -->
<div class="card mt-5 p-4 shadow-lg">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Latest Posts</h3>
  </div>

  <!-- Button to show/hide post form -->
  <button class="btn btn-success mb-3" id="showPostFormBtn">➕ Create Post</button>

  <!-- Hidden form -->
  <form method="POST" action="{{ url_for('main.create_post') }}" enctype="multipart/form-data" id="postForm" style="display: none;" class="mb-4">
      <div class="mb-3">
          <label for="title" class="form-label">Post Title</label>
          <input type="text" class="form-control" name="title" id="title" required>
      </div>
      <div class="mb-3">
          <label for="image" class="form-label">Upload Image (optional)</label>
          <input type="file" class="form-control" name="image" id="image" accept="image/*">
      </div>
      <div class="mb-3">
          <label for="file" class="form-label">Upload File (optional)</label>
          <input type="file" class="form-control" name="file" id="file">
      </div>
      <button type="submit" class="btn btn-primary">Post</button>
  </form>

  <script>
      document.getElementById("showPostFormBtn").addEventListener("click", function () {
          const form = document.getElementById("postForm");
          const button = this;
          if (form.style.display === "none") {
              $(form).slideDown();
              button.innerHTML = "✖️ Close Form";
          } else {
              $(form).slideUp();
              button.innerHTML = "➕ Create Post";
          }
      });
  </script>

  <!-- Posts list -->
  {% if posts %}
  <div class="d-flex overflow-auto" style="gap: 15px; padding-bottom: 10px;">
    {% for post in posts %}
    <div class="card shadow-sm" style="min-width: 250px; max-width: 250px; flex: 0 0 auto;">
      <div class="card-body">
        <h5 class="card-title">{{ post.title }}</h5>
        <small class="text-muted">By {{ post.user.username }} on {{ post.timestamp.strftime('%Y-%m-%d') }}</small>
        <hr>
        {% if post.image_filename %}
          <img src="{{ url_for('static', filename='uploads/' ~ post.image_filename) }}" 
               class="img-fluid rounded mb-2" 
               style="max-height: 150px; object-fit: cover;">
        {% endif %}
        {% if post.file_filename %}
          <p><a href="{{ url_for('static', filename='uploads/' ~ post.file_filename) }}" target="_blank">Download File</a></p>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
    <p class="text-muted">No posts yet. Be the first to share something!</p>
  {% endif %}
</div>

</div>
{% endblock %}
