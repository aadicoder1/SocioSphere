{% extends 'base.html' %}
{% block title %}Report Issue{% endblock %}

{% block head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
    #map {
        height: 375px;
        border-radius: 10px;
        width: 75%;
        margin: 10px auto;
        border: 1.5px solid grey;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="text-align:center; max-width:90%;">
    <h1 style="font-size:40px;">Report a New Issue</h1><br>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('report.report_issue') }}" enctype="multipart/form-data">
        <div class="mb-3">
            <input type="text" class="form-control" name="title" placeholder="Issue Title" required style="font-size: 18px;">
        </div><br>

        <div class="mb-3">
            <textarea class="form-control" name="description" placeholder="Describe the issue..." required style="font-size: 18px;"></textarea>
        </div><br>

        <div style="text-align:left;">
            <label for="image" style="font-size: 18px;" class="mb-3">Image (if any):</label>
            <input type="file" name="image" accept="image/*" class="form-control mb-3" style="font-size: 18px;"><br>

            <label for="location" style="font-size: 18px;" class="mb-3">Location (Address):</label>
            <input type="text" name="location" id="location" placeholder="Click on map to auto-fill" class="form-control mb-3" style="font-size: 18px;" required><br>

            <div id="map"></div>

            <input type="hidden" name="latitude" id="latitude">
            <input type="hidden" name="longitude" id="longitude">
        </div><br>

        <div style="text-align:left;">
            <button type="submit" class="btn btn-primary" style="font-size: 16px;">Submit Report</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    let map = L.map('map').setView([28.470257, 77.491885], 13); // Center at Noida/Delhi

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    let marker;

    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;

        if (marker) {
            marker.remove();
        }

        marker = L.marker([lat, lng]).addTo(map);

        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('location').value = data.display_name || "Address not found";
            })
            .catch(error => {
                console.error("Geocoding error:", error);
                document.getElementById('location').value = "Error fetching address";
            });
    });
</script>
{% endblock %}
